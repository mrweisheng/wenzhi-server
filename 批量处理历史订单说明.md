# 批量处理历史订单结算状态说明

## 问题背景

由于定时任务只处理最近3天的订单（为了性能考虑），导致6、7月份的历史订单没有自动变更为可结算状态，一直保持 `Pending` 状态。

## 解决方案

### 方案一：使用独立脚本（推荐）

1. **运行脚本**
   ```bash
   node fix-historical-settlement.js
   ```

2. **脚本功能**
   - 自动处理2024年6月-7月的所有Pending订单
   - 将符合条件的订单变更为Eligible状态
   - 输出详细的处理结果统计

3. **处理条件**
   - 订单已定稿（`is_fixed = 1`）
   - 客服录入金额与平台订单金额匹配（允许0.01元误差）

### 方案二：使用API接口

1. **接口地址**
   ```
   POST /api/customer-orders/batch-fix-settlement
   ```

2. **请求示例**
   ```json
   {
     "start_date": "2024-06-01",
     "end_date": "2024-07-31"
   }
   ```

3. **权限要求**
   - 仅限超级管理员和财务角色

## 处理逻辑

### 自动变更为Eligible的条件
1. **已定稿**: `is_fixed = 1`
2. **金额匹配**: `|客服录入金额 - 平台订单金额| ≤ 0.01`

### 处理流程
1. 查询指定时间范围内的所有Pending订单
2. 逐个检查是否满足条件
3. 批量更新符合条件的订单为Eligible
4. 保持不符合条件的订单为Pending
5. 记录操作日志

## 使用建议

### 1. 分批处理
如果历史订单数量很大，建议分批处理：
```bash
# 先处理6月份
node fix-historical-settlement.js 2024-06-01 2024-06-30

# 再处理7月份
node fix-historical-settlement.js 2024-07-01 2024-07-31
```

### 2. 验证结果
处理完成后，可以通过以下SQL查询验证结果：
```sql
SELECT 
  settlement_status,
  COUNT(*) as count,
  DATE_FORMAT(date, '%Y-%m') as month
FROM customer_orders 
WHERE date >= '2024-06-01' AND date <= '2024-07-31'
GROUP BY settlement_status, DATE_FORMAT(date, '%Y-%m')
ORDER BY month, settlement_status;
```

### 3. 注意事项
- 处理前建议先备份数据库
- 建议在业务低峰期执行
- 处理过程中不要中断，避免数据不一致

## 预期效果

处理完成后，6、7月份的订单结算状态分布应该变为：
- **Eligible**: 已定稿且金额匹配的订单
- **Pending**: 未定稿或金额不匹配的订单
- **其他状态**: 已手动处理过的订单

这样就能解决历史订单没有自动变更为可结算状态的问题。
